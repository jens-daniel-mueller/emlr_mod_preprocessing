---
title: "Cmorized climatology"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r define_paths, include=FALSE}
path_cmorized       <- "/nfs/kryo/work/loher/CESM_output/RECCAP2/cmorized_Dec2020/"
path_preprocessing  <- paste(path_root, "/model/preprocessing/", sep = "")
```

```{r library, include=FALSE}
library(tidync)
library(reticulate)
library(oce)
library(gsw)
library(geosphere)
library(marelac)
```


# Predictor climatology

Here we used annual output of cmorized (1x1) model with variable forcing (RECCAP2 RunA) in year 2007 as the predictor climatology. Predictors include:

- Salinity (sal)
- Potential temperature (theta, not predictor, used for temperature calculation)
- In-situ temperature (temp, calculated)
- DIC (tco2)
- ALK (talk)
- oxygen
- AOU (calculated)
- nitrate
- phosphate
- silicate

Besides, Model results are given in [mol m^-3^], whereas GLODAP data are in [µmol kg^-1^].

For comparison, model results were converted from [mol m^-3^] to [µmol kg^-1^]

## Read nc file

```{r read_cmorized_climatology}

# read in RECCAP2 RunA file
cmorized_climatology_temp <- tidync(paste(
  path_cmorized,
  "RECCAP2_RunA.nc",
  sep = ""
))

cmorized_climatology <- cmorized_climatology_temp %>% hyper_tibble()

# select annual cmorized 2007 as climatology
cmorized_climatology <- cmorized_climatology %>%
  select(-epc) %>%
  rename(year = time_ann,
    sal = so,
    THETA = thetao,
    tco2 = dissic,
    talk = talk,
    oxygen = o2,
    nitrate = no3,
    phosphate = po4,
    silicate = si
  ) %>%
  # select annual value in year of 2007
  filter(year == 10036) %>%
  drop_na() %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon)) %>%
  mutate(depth = round(depth))

rm(cmorized_climatology_temp)

```


## Apply basin mask

```{r apply_basin_mask}

# use only three basin to assign general basin mask
# ie this is not specific to the MLR fitting
basinmask <- basinmask %>% 
  filter(MLR_basins == "2") %>% 
  select(lat, lon, basin_AIP)

# restrict predictor fields to basin mask grid
cmorized_climatology <- inner_join(cmorized_climatology, basinmask)

```


## Calculate in-situ temperature

```{r calculate_temperature}

cmorized_climatology <- cmorized_climatology %>%
  mutate(temp = gsw_pt_from_t(
    SA = sal,
    t = THETA,
    p = 10.1325,
    p_ref = depth
  ))

```

### Profile

Example profile from North Atlantic Ocean.

```{r temp_theta_profile_plot}

cmorized_climatology %>%
  filter(lat == params_global$lat_Atl_profile,
         lon == params_global$lon_Atl_section) %>%
  ggplot() +
  geom_line(aes(temp, depth, col = "insitu")) +
  geom_point(aes(temp, depth, col = "insitu")) +
  geom_line(aes(THETA, depth, col = "theta")) +
  geom_point(aes(THETA, depth, col = "theta")) +
  scale_y_reverse() +
  scale_color_brewer(palette = "Dark2", name = "Scale")

```


## Unit transfer

```{r unit_transfer}

# unit transfer from mol/m3 to µmol/kg
cmorized_climatology <- cmorized_climatology %>%
  mutate(
    rho = gsw_pot_rho_t_exact(
      SA = sal,
      t = temp,
      p = depth,
      p_ref = 10.1325
    ),
    tco2 = tco2 * (1000000 / rho),
    talk = talk * (1000000 / rho),
    oxygen = oxygen * (1000000 / rho),
    nitrate = nitrate * (1000000 / rho),
    phosphate = phosphate * (1000000 / rho),
    silicate = silicate * (1000000 / rho)
  )

```


## calculate AOU

```{r calculate_AOU}

cmorized_climatology <- cmorized_climatology %>%
  mutate(
    oxygen_sat_m3 = gas_satconc(
      S = sal,
      t = temp,
      P = 1.013253,
      species = "O2"
    ),
    oxygen_sat_kg = oxygen_sat_m3 * (1000 / rho),
    AOU = oxygen_sat_kg - oxygen
  ) %>%
  select(-oxygen_sat_kg,-oxygen_sat_m3)

```


## Calculate neutral density

Neutral density gamma was calculated with a Python script provided by Serazin et al (2011), which performs a polynomial approximation of the original gamma calculation.

```{r calculate_neutral_density}

# calculate pressure from depth
cmorized_climatology <- cmorized_climatology %>%
  mutate(CTDPRS = gsw_p_from_z(-depth,
                               lat))

# rename variables according to python script
cmorized_climatology_gamma_prep <- cmorized_climatology %>%
  rename(LATITUDE = lat,
         LONGITUDE = lon,
         SALNTY = sal)

# load python scripts
source_python(paste(
  path_functions,
  "python_scripts/Gamma_GLODAP_python.py",
  sep = ""
))

# calculate gamma
cmorized_climatology_gamma_calc <-
  calculate_gamma(cmorized_climatology_gamma_prep)

# reverse variable naming
cmorized_climatology <- cmorized_climatology_gamma_calc %>%
  select(-c(CTDPRS, THETA)) %>%
  rename(
    lat = LATITUDE,
    lon = LONGITUDE,
    sal = SALNTY,
    gamma  = GAMMA
  )

cmorized_climatology <- as_tibble(cmorized_climatology)

rm(cmorized_climatology_gamma_calc, cmorized_climatology_gamma_prep)

```

## Write file

```{r write_climatology_predictor_file}

cmorized_climatology %>%
  write_csv(paste(path_preprocessing,
                  "cmorized_climatology.csv",
                  sep = ""))

```


# Plots

## Temperature plots

Below, following subsets of the climatology are plotted for all relevant predictors:  

- Horizontal planes at `r params_global$depth_levels`m
- Global section as defined above and indicated as white lines in maps.

### Surface map

```{r temperature_surface_climatology_map, fig.asp=0.6}

p_map_climatology(
  df = cmorized_climatology,
  var = "temp")

```

### Section

```{r temperature_sections_climatology}

p_section_global(
  df = cmorized_climatology,
  var = "temp")

```

## Salinity plots

### Surface map

```{r salinity_surface_climatology_map}

p_map_climatology(
  df = cmorized_climatology,
  var = "sal")

```

### Section

```{r salinity_sections_climatology}

p_section_global(
  df = cmorized_climatology,
  var = "sal")

```

## Nitrate plots

### Surface map

```{r nitrate_surface_climatology_map}

p_map_climatology(
  df = cmorized_climatology,
  var = "nitrate")

```

### Section

```{r nitrate_sections_climatology}

p_section_global(
  df = cmorized_climatology,
  var = "nitrate")

```

## Phosphate plots

### Surface map

```{r phosphate_surface_climatology_map}

p_map_climatology(
  df = cmorized_climatology,
  var = "phosphate")

```

### Section

```{r phosphate_sections_climatology}

p_section_global(
  df = cmorized_climatology,
  var = "phosphate")

```

## Silicate plots

### Surface map

```{r silicate_surface_climatology_map}

p_map_climatology(
  df = cmorized_climatology,
  var = "silicate")

```

### Section

```{r silicate_sections_climatology}

p_section_global(
  df = cmorized_climatology,
  var = "silicate")

```

## Oxygen plots

### Surface map

```{r oxygen_surface_climatology_map}

p_map_climatology(
  df = cmorized_climatology,
  var = "oxygen")

```

### Section

```{r oxygen_sections_climatology}

p_section_global(
  df = cmorized_climatology,
  var = "oxygen")

```

## AOU plots

### Surface map

```{r AOU_surface_climatology_map}

p_map_climatology(
  df = cmorized_climatology,
  var = "AOU")

```

### Section

```{r AOU_sections_climatology}

p_section_global(
  df = cmorized_climatology,
  var = "AOU")

```
