---
title: "Anthropogenic CO2 from 1994 to 2007"
author: "Jens Daniel MÃ¼ller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r define_paths}
path_sabine_2004    <- "/nfs/kryo/work/updata/glodapv1_1/GLODAP_gridded.data/"
path_preprocessing  <- paste(path_root, "/model/preprocessing/", sep = "")
```

# Data source

- Anthropogenic CO2 estimates (1800-1994) by Sabine et al. (2004) downloaded in August 2020 from [NOAA/NCEI Ocean Carbon Data System (OCADS)](ftp://ftp.nodc.noaa.gov/pub/data.nodc/ncei/ocads/data/0001644/){target="_blank"}

# Read nc files

```{r read_Sabine_2004}

# read text files
AnthCO2_data <-
  read_csv(
    paste(path_sabine_2004,
          "AnthCO2.data/AnthCO2.data.txt",
          sep = ""),
    col_names = FALSE,
    na = "-999",
    col_types = list(.default = "d")
  )

# read respective depth layers and convert to vector
Depth_centers <-
  read_file(paste(path_sabine_2004,
                  "Depth.centers.txt",
                  sep = ""))

Depth_centers <- Depth_centers %>%
  str_split(",") %>%
  as_vector()

# read respective latitudes and convert to vector
Lat_centers <-
  read_file(paste(path_sabine_2004, "Lat.centers.txt",
                  sep = ""))

Lat_centers <- Lat_centers %>%
  str_split(",") %>%
  as_vector()

# read respective longitudes and convert to vector
Long_centers <-
  read_file(paste(path_sabine_2004, "Long.centers.txt",
                  sep = ""))

Long_centers <- Long_centers %>%
  str_split(",") %>%
  as_vector()

# match lon, lat and depth vectors with Cant value file
names(AnthCO2_data) <- Lat_centers

Long_Depth <-
  expand_grid(depth = Depth_centers, lon = Long_centers) %>%
  mutate(lon = as.numeric(lon),
         depth = as.numeric(depth))

cant_3d <- bind_cols(AnthCO2_data, Long_Depth)

# adjust file dimensions
cant_3d <- cant_3d %>%
  pivot_longer(1:180, names_to = "lat", values_to = "cant") %>%
  mutate(lat = as.numeric(lat))

cant_3d <- cant_3d %>%
  drop_na()

# harmonize coordinates
cant_3d <- cant_3d %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon))

rm(AnthCO2_data,
   Long_Depth,
   Depth_centers,
   Lat_centers,
   Long_centers)

```

# Apply basin mask

```{r apply_basin_mask}

# use only three basin to assign general basin mask
# ie this is not specific to the MLR fitting
basinmask <- basinmask %>% 
  filter(MLR_basins == "2") %>% 
  select(lat, lon, basin_AIP)

cant_3d <- inner_join(cant_3d, basinmask)

```


# Calculation

## Column inventory

```{r calculate_inventory}

cant_3d <- cant_3d %>% 
  mutate(cant_pos = if_else(cant <= 0, 0, cant),
         eras = "1800-1994")

cant_inv_layers <- m_cant_inv(cant_3d)

cant_inv <- cant_inv_layers %>% 
  filter(inv_depth == params_global$inventory_depth_standard)

```

## Zonal mean section

```{r calculate_zonal_mean_section}

cant_zonal <- m_zonal_mean_section(cant_3d)

```


# Plots


## Inventory map

```{r cant_pos_inventory_maps, fig.asp=0.6}

p_map_cant_inv(
  df = cant_inv,
  var = "cant_pos_inv",
  breaks = seq(0,max(cant_inv$cant_pos_inv),5))

```

## Horizontal plane maps

```{r cant_maps, fig.asp=0.6}

p_map_climatology(
  df = cant_3d,
  var = "cant",
  col = "divergent")

```

## Global section

```{r cant_sections}

p_section_global(
  df = cant_3d,
  var = "cant",
  col = "divergent")

```

## Sections at regular longitudes

```{r cant_sections_regular, fig.asp=2}

p_section_climatology_regular(
  df = cant_3d,
  var = "cant",
  col = "divergent")

```

## Write files

```{r write_Sabine_2004_cant_file}

cant_3d %>%
  write_csv(paste(path_preprocessing,
                  "S04_cant_3d.csv", sep = ""))

cant_inv %>%
  write_csv(paste(path_preprocessing,
                  "S04_cant_inv.csv", sep = ""))

cant_zonal %>%
  write_csv(paste(path_preprocessing,
                  "S04_cant_zonal.csv", sep = ""))


```
