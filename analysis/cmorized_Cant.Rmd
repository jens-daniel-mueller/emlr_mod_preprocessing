---
title: "Annual cmorized Cant field"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r define_paths, include=FALSE}
path_cmorized <-
  "/nfs/kryo/work/loher/CESM_output/RECCAP2/cmorized_Dec2020/"
path_preprocessing  <-
  paste(path_root, "/model/preprocessing/", sep = "")
```

```{r load_libraries_specific, include=FALSE}
library(tidync)
library(stars)
library(gsw)
```


# Calculate annual Cant field

## Read in cmorized RunA file

```{r read_cmorized_RunA}

# read in cmorized variable forcing model file
A_annual <- tidync(paste(path_cmorized,
                         "RECCAP2_RunA.nc",
                         sep = ""))

A_annual <- A_annual %>% hyper_tibble()

# harmonize column names and coordinates
A_annual <- A_annual  %>%
  select(year = time_ann, lon, lat, depth, tco2_A = dissic, sal = so, theta = thetao) %>%
  # select annual value in year of 2007
  mutate(year = (year - 181) / 365 + 1980) %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon))

# calculate model temperature
A_annual <- A_annual %>%
  mutate(temp = gsw_pt_from_t(
    SA = sal,
    t = theta,
    p = 10.1325,
    p_ref = depth
  ))

# unit transfer from mol/m3 to µmol/kg
A_annual <- A_annual %>%
  mutate(
    rho = gsw_pot_rho_t_exact(
      SA = sal,
      t = temp,
      p = depth,
      p_ref = 10.1325
    ),
    tco2_A = tco2_A * (1000000 / rho)
  ) %>%
  select(year, lon, lat, depth, tco2_A)

```

## Read in cmorized RunB file

```{r read_cmorized_RunB}

# read in cmorized variable forcing model file
B_annual <- tidync(paste(path_cmorized,
                         "RECCAP2_RunB.nc",
                         sep = ""))

B_annual <- B_annual %>% hyper_tibble()

# harmonize column names and coordinates
B_annual <- B_annual  %>%
  select(year = time_ann, lon, lat, depth, tco2_B = dissic, sal = so, theta = thetao) %>%
  # select annual value in year of 2007
  mutate(year = (year - 181) / 365 + 1980) %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon))

# calculate model temperature
B_annual <- B_annual %>%
  mutate(temp = gsw_pt_from_t(
    SA = sal,
    t = theta,
    p = 10.1325,
    p_ref = depth
  ))

# unit transfer from mol/m3 to µmol/kg
B_annual <- B_annual %>%
  mutate(
    rho = gsw_pot_rho_t_exact(
      SA = sal,
      t = temp,
      p = depth,
      p_ref = 10.1325
    ),
    tco2_B = tco2_B * (1000000 / rho)
  ) %>%
  select(year, lon, lat, depth, tco2_B)

# join files and calculate Cant field
cant_annual <- inner_join(A_annual, B_annual) %>%
  mutate(cant = tco2_A - tco2_B)

rm(A_annual, B_annual)

```

## Apply basin mask

```{r apply_basin_mask}

# use only three basin to assign general basin mask
# ie this is not specific to the MLR fitting
basinmask <- basinmask %>% 
  filter(MLR_basins == "2") %>% 
  select(lat, lon, basin_AIP)

# restrict Cant field to basin mask grid
cant_annual <- inner_join(cant_annual, basinmask)

```

## Calculate dCant for year 1994 - 2007

```{r calculate_dCant}

cant_annual_1994 <- cant_annual %>%
  filter(year == 1994) %>%
  select(-c(tco2_A, tco2_B, year)) %>%
  rename(cant_1994 = cant)

cant_annual_2007 <- cant_annual %>%
  filter(year == 2007) %>%
  select(-c(tco2_A, tco2_B, year)) %>%
  rename(cant_2007 = cant)

dcant_gruber <- left_join(cant_annual_1994, cant_annual_2007) %>%
  mutate(dcant = cant_2007 - cant_1994)

rm(cant_annual_1994, cant_annual_2007)

```

## Write Cant files

```{r write_annual_Cant_files}

# write combined Cant file
cant_annual %>%
  write_csv(paste(
    path_preprocessing,
    "cant_annual_field/cant_all_years.csv",
    sep = ""
  ))

# write annual Cant files
years <- c(1982:2019)
for (i_year in years) {
  
 # i_year = years[1]
  cant_annual_year <- cant_annual %>%
    filter(year == i_year) %>%
    select(year, lon, lat, depth, cant)
  
  cant_annual_year %>%
    write_csv(paste(path_preprocessing,
                    "cant_annual_field/cant_", i_year, ".csv",
                    sep = ""))
}

# write dCant gruber file
dcant_gruber %>%
  write_csv(paste(
    path_preprocessing,
    "cant_annual_field/dcant_gruber.csv",
    sep = ""
  ))

rm(cant_annual_year)

```

# Zonal mean section

```{r calculate_zonal_mean_section}

# Zonal mean section for Cant
cant_annual_zonal <- cant_annual %>%
  select(-c(lon, tco2_A, tco2_B)) %>%
  fgroup_by(lat, depth, year, basin_AIP) %>% {
    add_vars(
      fgroup_vars(., "unique"),
      fmean(., keep.group_vars = FALSE) %>% add_stub(pre = FALSE, "_mean"),
      fsd(., keep.group_vars = FALSE) %>% add_stub(pre = FALSE, "_sd")
    )
  }

# Zonal mean section for dCant
dcant_gruber_zonal <- dcant_gruber %>%
  select(-c(lon, cant_1994, cant_2007)) %>%
  fgroup_by(lat, depth, basin_AIP) %>% {
    add_vars(
      fgroup_vars(., "unique"),
      fmean(., keep.group_vars = FALSE) %>% add_stub(pre = FALSE, "_mean"),
      fsd(., keep.group_vars = FALSE) %>% add_stub(pre = FALSE, "_sd")
    )
  }

```

# Column inventory 

## Calculation

```{r calculate_column_inventory}

# Calculate column inventory for Cant in year 2007
for (i_inventory_depth in params_global$inventory_depths) {
  # filter integration depth
  cant_annual_temp <- cant_annual %>%
    filter(year == 2007, depth <= i_inventory_depth)
  
  depth_level_volume <- tibble(depth = unique(cant_annual_temp$depth)) %>%
    arrange(depth)
  
  # determine depth level volume of each depth layer
  depth_level_volume <- depth_level_volume %>%
    mutate(
      layer_thickness_above = replace_na((depth - lag(depth)) / 2, 0),
      layer_thickness_below = replace_na((lead(depth) - depth) / 2, 0),
      layer_thickness = layer_thickness_above + layer_thickness_below
    ) %>%
    select(-c(layer_thickness_above,
              layer_thickness_below))
  
  cant_annual_temp <-
    full_join(cant_annual_temp, depth_level_volume)
  
  # calculate cant layer inventory
  cant_annual_temp <- cant_annual_temp %>%
    mutate(cant_layer_inv = cant * layer_thickness * 1.03) %>%
    select(-layer_thickness)
  
  # sum up layer inventories to column inventories
  cant_annual_inv_temp <- cant_annual_temp %>%
    group_by(lon, lat, basin_AIP) %>%
    summarise(cant_inv = sum(cant_layer_inv, na.rm = TRUE) / 1000) %>%
    ungroup()
  
  cant_annual_inv_temp <- cant_annual_inv_temp %>%
    mutate(inv_depth = i_inventory_depth)
  
  if (exists("cant_annual_inv")) {
    cant_annual_inv <- bind_rows(cant_annual_inv, cant_annual_inv_temp)
  }
  
  if (!exists("cant_annual_inv")) {
    cant_annual_inv <- cant_annual_inv_temp
  }
}

cant_annual_inv <- cant_annual_inv %>%
  filter(inv_depth == params_global$inventory_depth_standard)

rm(cant_annual_inv_temp, cant_annual_temp)

# Calculate column inventory for dCant
for (i_inventory_depth in params_global$inventory_depths) {
  # filter integration depth
  dcant_gruber_temp <- dcant_gruber %>%
    filter(depth <= i_inventory_depth)
  
  depth_level_volume <- tibble(depth = unique(dcant_gruber_temp$depth)) %>%
    arrange(depth)
  
  # determine depth level volume of each depth layer
  depth_level_volume <- depth_level_volume %>%
    mutate(
      layer_thickness_above = replace_na((depth - lag(depth)) / 2, 0),
      layer_thickness_below = replace_na((lead(depth) - depth) / 2, 0),
      layer_thickness = layer_thickness_above + layer_thickness_below
    ) %>%
    select(-c(layer_thickness_above,
              layer_thickness_below))
  
  dcant_gruber_temp <-
    full_join(dcant_gruber_temp, depth_level_volume)
  
  # calculate cant layer inventory
  dcant_gruber_temp <- dcant_gruber_temp %>%
    mutate(dcant_layer_inv = dcant * layer_thickness * 1.03) %>%
    select(-layer_thickness)
  
  # sum up layer inventories to column inventories
  dcant_gruber_inv_temp <- dcant_gruber_temp %>%
    group_by(lon, lat, basin_AIP) %>%
    summarise(cant_inv = sum(dcant_layer_inv, na.rm = TRUE) / 1000) %>%
    ungroup()
  
  dcant_gruber_inv_temp <- dcant_gruber_inv_temp %>%
    mutate(inv_depth = i_inventory_depth)
  
  if (exists("dcant_gruber_inv")) {
    dcant_gruber_inv <- bind_rows(dcant_gruber_inv, dcant_gruber_inv_temp)
  }
  
  if (!exists("dcant_gruber_inv")) {
    dcant_gruber_inv <- dcant_gruber_inv_temp
  }
}

dcant_gruber_inv <- dcant_gruber_inv %>%
  filter(inv_depth == params_global$inventory_depth_standard)

rm(dcant_gruber_inv_temp, dcant_gruber_temp)

```

## Inventory plots

### Cant inventory

```{r plot_cant_inventory}

# Cant inventory plot in year 2007
p_map_cant_inv(
  df = cant_annual_inv,
  var = "cant_inv")

```

### dCant inventory

```{r plot_dcant_inventory}

# dCant inventory plot between 1994 to 2007
p_map_cant_inv(
  df = dcant_gruber_inv,
  var = "cant_inv")

```

# Cant plots in 2007

## Horizontal plane maps

```{r plot_cant_horizontal}

# Cant horizontal plane plot in year 2007
cant_annual_year <- cant_annual %>%
  filter(year == 2007) %>%
  mutate(depth = round(depth))

p_map_climatology(df = cant_annual_year, var = "cant")

```

## Zonal mean section plot

```{r plot_cant_zonal_mean_section}

# Cant zonal mean section plot in year 2007
for (i_basin_AIP in unique(cant_annual_zonal$basin_AIP)) {
  print(
    p_section_zonal(
      df = cant_annual_zonal %>% filter(basin_AIP == i_basin_AIP),
      var = "cant_mean",
      plot_slabs = "n",
      subtitle_text = paste("Basin:", i_basin_AIP)
    )
  )
}

```

## Global sections plot

```{r plot_cant_global_section}

# Cant global mean section plot in year 2007
cant_annual_year <- cant_annual %>%
  filter(year == 2007)

p_section_global(
  df = cant_annual_year,
  var = "cant",
  col = "divergent")

```


# dCant plots in 2007

## Horizontal plane maps

```{r plot_dcant_horizontal}

# Cant horizontal plane plot in year 2007
dcant_gruber_round <- dcant_gruber %>%
  mutate(depth = round(depth))

p_map_climatology(df = dcant_gruber_round, var = "dcant")

rm(dcant_gruber_round)

```

## Zonal mean section plot

```{r plot_dcant_zonal_mean_section}

# Cant zonal mean section plot in year 2007
for (i_basin_AIP in unique(dcant_gruber_zonal$basin_AIP)) {
  print(
    p_section_zonal(
      df = dcant_gruber_zonal %>% filter(basin_AIP == i_basin_AIP),
      var = "dcant_mean",
      plot_slabs = "n",
      subtitle_text = paste("Basin:", i_basin_AIP)
    )
  )
}

```

## Global sections plot

```{r plot_dcant_global_section}

# Cant global mean section plot in year 2007
p_section_global(
  df = dcant_gruber,
  var = "dcant",
  col = "divergent")

```
