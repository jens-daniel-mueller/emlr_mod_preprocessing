---
title: "GLODAPv2_2020"
author: "Jens Daniel Müller"
date:  "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  workflowr::wflow_html:
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r parent, child = "/nfs/kryo/work/jenmueller/emlr_cant/utilities/setup.Rmd"}
# this chunk runs the code stored in setup.Rmd
# if required, please refer to instructions given here:
# https://jdblischak.github.io/workflowr/articles/wflow-07-common-code.html
```

```{r define_paths}
path_glodapv2_2020  <- "/nfs/kryo/work/updata/glodapv2_2020/"
path_preprocessing  <- paste(path_root, "/observations/preprocessing/", sep = "")
```

```{r load_libraries_specific, include=FALSE}
library(lubridate)
```


# Read files

Main data source for this project is `GLODAPv2.2020_Merged_Master_File.csv` downloaded from [glodap.info](https://www.glodap.info/){target="_blank"} in June 2020.

```{r read_GLODAPv2_2020_merged_master_file}

GLODAP <-
  read_csv(
    paste(
      path_glodapv2_2020,
      "GLODAPv2.2020_Merged_Master_File.csv",
      sep = ""
    ),
    na = "-9999",
    col_types = cols(.default = col_double())
  )

```

```{r harmonize_variables}

# select relevant columns
GLODAP <- GLODAP %>%
  select(cruise:talkqc)

# create date column
GLODAP <- GLODAP %>%
  mutate(date = ymd(paste(year, month, day))) %>%
  relocate(date)

# harmonize column names
GLODAP <- GLODAP  %>%
  rename(sal = salinity,
         temp = temperature)

# harmonize coordinates
GLODAP <- GLODAP  %>%
  rename(lon = longitude,
         lat = latitude) %>%
  mutate(lon = if_else(lon < 20, lon + 360, lon))

# remove irrelevant columns
GLODAP <- GLODAP %>%
  select(-c(month:minute,
            maxsampdepth, bottle, sigma0:sigma4,
            nitrite:nitritef))

```

# Data preparation

## Subset tco2 data

The vast majority of rows is removed due to missing `tco2` observations.

```{r tco2_na_subset}

GLODAP <- GLODAP %>% 
  filter(!is.na(tco2))

```

## Horizontal gridding

For merging with other data sets, all observations were grouped into latitude intervals of:

- 1° x 1°

```{r grid_spatially_1x1}

GLODAP <- m_grid_horizontal(GLODAP)

```

## Apply basin mask

```{r apply_basin_mask}

# use only three basin to assign general basin mask
# ie this is not specific to the MLR fitting
basinmask <- basinmask %>% 
  filter(MLR_basins == "2") %>% 
  select(lat, lon, basin_AIP)

GLODAP <- inner_join(GLODAP, basinmask)

```

## Create clean observations grid

```{r create_clean_obs_grid}

GLODAP_obs_grid <- GLODAP %>% 
  count(lat, lon)

```

## Write file
 
```{r write_clean_data_files}

GLODAP  %>%  write_csv(paste(path_preprocessing,
                             "GLODAPv2.2020_preprocessed.csv",
                             sep = ""))

```


# Overview plots

## Assign coarse spatial grid

For the following plots, the cleaned data set was re-opened and observations were gridded spatially to intervals of:  

- 5° x 5°

```{r grid_spatially_5x5}

GLODAP <- m_grid_horizontal_coarse(GLODAP)

```


## Histogram Zonal coverage

```{r coverage_histogram_zonal}

GLODAP_histogram_lat <- GLODAP %>%
  group_by(lat_grid) %>%
  tally() %>%
  ungroup()

GLODAP_histogram_lat %>%
  ggplot(aes(lat_grid, n)) +
  geom_col() +
  coord_flip() +
  theme(legend.title = element_blank())

rm(GLODAP_histogram_lat)

```

## Histogram temporal coverage

```{r coverage_histogram_temporal}

GLODAP_histogram_year <- GLODAP %>%
  group_by(year) %>%
  tally() %>%
  ungroup()

GLODAP_histogram_year %>%
  ggplot() +
  geom_col(aes(year, n)) +
  theme(
    axis.title.x = element_blank()
  )

rm(GLODAP_histogram_year)

```

## Zonal temporal coverage (Hovmoeller)

```{r coverage_hovmoeller}

GLODAP_hovmoeller_year <- GLODAP %>%
  group_by(year, lat_grid) %>%
  tally() %>%
  ungroup()

GLODAP_hovmoeller_year %>%
  ggplot(aes(year, lat_grid, fill = log10(n))) +
  geom_tile() +
  geom_vline(xintercept = c(1999.5, 2012.5)) +
  scale_fill_viridis_c(option = "magma", direction = -1) +
  theme(legend.position = "top",
        axis.title.x = element_blank())

rm(GLODAP_hovmoeller_year)

```

## Coverage map

```{r coverage_map, fig.asp=0.5}

map +
  geom_raster(data = GLODAP_obs_grid,
              aes(lon, lat, fill = log10(n))) +
  scale_fill_viridis_c(option = "magma",
                       direction = -1)

```

